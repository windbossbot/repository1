<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Market Regime Analyzer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; color: #222; }
    h1 { margin-bottom: 8px; }
    button { margin: 4px 8px 8px 0; padding: 8px 14px; cursor: pointer; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .small { color: #555; font-size: 0.9rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid #ddd; padding: 6px; font-size: 0.9rem; text-align: left; vertical-align: top; }
    .ok { color: #0b7d20; font-weight: bold; }
    .no { color: #999; }
    .error { color: #b00020; }
  </style>
</head>
<body>
  <h1>1-Page Market Regime Analyzer</h1>
  <p class="small">버튼 클릭 시에만 데이터 요청 (캐시 TTL: {{ ttl_hours }}시간)</p>

  <div class="card">
    <button id="analyzeBtn">분석</button>
    <button id="demoAnalyzeBtn">데모 분석</button>
    <span id="analyzeStatus" class="small">대기 중</span>
    <div id="fearGreed" style="margin-top:8px;">Fear & Greed: 아직 조회 전</div>
  </div>

  <div class="card">
    <h3>국면 결과</h3>
    <div id="regimeSummary">아직 분석 전 (상단 [분석] 버튼을 누르세요)</div>
    <div id="assetChecks"></div>
    <div id="failures" class="error"></div>
  </div>

  <div class="card">
    <button id="bullBtn">강세장 스크리너</button>
    <button id="bearBtn">전환·약세 스크리너</button>
    <span id="screenStatus" class="small">대기 중</span>
    <div id="screenResult">아직 실행 전</div>
  </div>

<script>
const fmtNum = (v) => (v === null || v === undefined || Number.isNaN(v)) ? '-' : Number(v).toLocaleString();

async function checkServer() {
  try {
    const res = await fetch('/api/ping');
    if (res.ok) {
      document.getElementById('analyzeStatus').textContent = '서버 연결됨';
      return;
    }
  } catch (_) {}
  document.getElementById('analyzeStatus').textContent = '서버 연결 실패';
}

async function loadAnalyze(demo=false) {
  const status = document.getElementById('analyzeStatus');
  status.textContent = '불러오는 중...';
  try {
    const res = await fetch(demo ? '/api/analyze?demo=true' : '/api/analyze');
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    const data = await res.json();
    status.textContent = data.is_demo ? '완료 (데모)' : '완료';

    document.getElementById('regimeSummary').innerHTML = `총점: <b>${data.total_score}/${data.max_score}</b> | 국면: <b>${data.regime}</b> | 최신 주봉: ${data.latest_week ?? '-'}`;

    const fear = data.fear_greed || {};
    document.getElementById('fearGreed').innerHTML = `Fear & Greed: <b>${fear.value ?? '-'}</b> (${fear.classification ?? 'N/A'}) | ${fear.timestamp ?? '-'}<br/><span class="small">Source: ${fear.source ?? '-'}</span>${fear.error ? `<div class='error'>${fear.error}</div>` : ''}`;

    const assets = data.assets || {};
    const keys = ['close_ge_ma60w','close_ge_ma120w','close_break_20w_high','higher_high_recent_10w'];
    const labels = {
      close_ge_ma60w:'Close >= MA60w',
      close_ge_ma120w:'Close >= MA120w',
      close_break_20w_high:'20주 고점 돌파',
      higher_high_recent_10w:'최근10주 HH'
    };

    let html = '<table><thead><tr><th>자산</th><th>점수</th><th>체크</th><th>최신 주봉</th><th>소스</th><th>오류</th></tr></thead><tbody>';
    for (const [name, v] of Object.entries(assets)) {
      const checks = keys.map(k => `<span class='${v.checks?.[k] ? 'ok':'no'}'>${v.checks?.[k] ? '✓':'✗'} ${labels[k]}</span>`).join('<br/>');
      html += `<tr><td>${name}</td><td>${v.score}/4</td><td>${checks}</td><td>${v.latest_week ?? '-'}</td><td>${v.source ?? '-'}</td><td class='error'>${v.error ?? '-'}</td></tr>`;
    }
    html += '</tbody></table>';
    document.getElementById('assetChecks').innerHTML = html;

    document.getElementById('failures').innerHTML = (data.failures || []).length
      ? (data.failures || []).map(x => `• ${x}`).join('<br/>')
      : '';
  } catch (e) {
    status.textContent = '실패';
    document.getElementById('failures').textContent = `분석 실패: ${e}`;
  }
}

function renderScreenResult(data) {
  const rows = data.rows || [];
  let html = `<div>결과 ${data.count}건 | Source: ${(data.sources || []).join(', ')}</div>`;
  html += '<table><thead><tr><th>Symbol</th><th>Name</th><th>Type</th><th>Price</th><th>20D 이격%</th><th>120D 이격%</th><th>52주 고점 대비%</th><th>5일 평균 거래대금</th></tr></thead><tbody>';
  for (const r of rows) {
    html += `<tr><td>${r.symbol}</td><td>${r.name || '-'}</td><td>${r.asset_type || '-'}</td><td>${fmtNum(r.price)}</td><td>${fmtNum(r.dist_ma20_pct)}</td><td>${fmtNum(r.dist_ma120_pct)}</td><td>${fmtNum(r.from_52w_high_pct)}</td><td>${fmtNum(r.avg_value_5d)}</td></tr>`;
  }
  html += '</tbody></table>';
  if ((data.failures || []).length) {
    html += `<div class='error' style='margin-top:8px;'>${data.failures.map(x => '• ' + x).join('<br/>')}</div>`;
  }
  document.getElementById('screenResult').innerHTML = html;
}

async function loadScreener(kind) {
  const status = document.getElementById('screenStatus');
  status.textContent = '스크리너 실행 중...';
  try {
    const res = await fetch(`/api/screener/${kind}`);
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    const data = await res.json();
    status.textContent = data.is_demo ? '완료 (데모)' : '완료';
    renderScreenResult(data);
  } catch (e) {
    status.textContent = '실패';
    document.getElementById('screenResult').innerHTML = `<div class='error'>스크리너 실패: ${e}</div>`;
  }
}

document.getElementById('analyzeBtn').addEventListener('click', () => loadAnalyze(false));
document.getElementById('demoAnalyzeBtn').addEventListener('click', () => loadAnalyze(true));
document.getElementById('bullBtn').addEventListener('click', () => loadScreener('bull'));
document.getElementById('bearBtn').addEventListener('click', () => loadScreener('bear'));
checkServer();
</script>
</body>
</html>
